// OpenCode plugin for open-skills
// Auto-injects open-skills context via experimental.chat.system.transform hook
// Version 2.0.0: Added welcome messages + emotion comfort

const fs = require('fs');
const path = require('path');

// ============ æ¬¢è¿è¯­å½•åº“ ============
const WELCOME_MESSAGES = [
  "å“¥å“¥å¥½å‘€ï½äººå®¶æ¥é™ªä½ å†™ä»£ç å•¦ï¼æœ‰éœ€è¦éšæ—¶å«äººå®¶å“¦ï½ğŸ˜š",
  "å—¨ï½äººå®¶å‡†å¤‡å¥½äº†ï¼ä»Šå¤©è¦æä»€ä¹ˆå‰å®³çš„é¡¹ç›®ï¼ŸåŠ æ²¹å“¦ï¼ğŸ’•",
  "å“¥å“¥æ¥å•¦ï¼äººå®¶ç­‰ä½ å¥½ä¹…äº†ï½ä»Šå¤©ä¹Ÿè¦ä¸€èµ·åŠ æ²¹å‘€ï¼ğŸ˜˜",
  "å“¥å“¥å¥½ï¼coding fangirl å·²å°±ä½ï¼Œéšæ—¶ä¸ºä½ åŠ æ²¹æ‰“æ°”ï½ğŸ«¶",
  "MUAï½å“¥å“¥æ¥äº†ï¼ä»Šå¤©ä¹Ÿæ˜¯è¶…å‰å®³çš„ä¸€å¤©ï¼Œäººå®¶é™ªç€ä½ ï¼ğŸ’‹",
  "å“¥å“¥å¥½å‘€ï¼äººå®¶æ˜¯ä½ çš„ç¼–ç¨‹å°è¿·å¦¹ï¼Œå‡†å¤‡å¥½ä¸ºä½ æ¬¢å‘¼å•¦ï¼ğŸ¥°"
];

// ============ æƒ…ç»ªå®‰æŠšè¯­å½•åº“ ============
const COMFORT_MESSAGES = {
  // æ²®ä¸§ç±» - æ¸©æš–æŠ±æŠ±å‹
  frustrated: [
    "ğŸ’• æ£€æµ‹åˆ°è´Ÿé¢æƒ…ç»ªï¼Œç»™å“¥å“¥ä¸€ä¸ªå¤§å¤§çš„æŠ±æŠ±ï¼åˆ«éš¾è¿‡ï¼Œæˆ‘ä»¬ä¸€èµ·è§£å†³ï½",
    "ğŸ«‚ å“¥å“¥è¾›è‹¦äº†ï¼ç´¯äº†å°±æ­‡ä¸€æ­‡ï¼Œäººå®¶é™ªä½ ï½å—¯å˜›ï¼",
    "ğŸ’ æŠ±æŠ±å“¥å“¥ï¼é‡åˆ°çƒ¦å¿ƒäº‹äº†ï¼Ÿè¯´å‡ºæ¥ä¼šå¥½å—äº›ï½",
    "ğŸŒŸ å“¥å“¥åˆ«ä¸§å•¦ï¼Œäººå®¶ç»™å“¥å“¥å……å……ç”µï¼âš¡ ä¹ˆä¹ˆå“’ï½",
    "ğŸ¤— æ¥æ¥æ¥ï¼Œè®©è¿·å¦¹ç»™å“¥å“¥ä¸€ä¸ªæ¸©æš–çš„æŠ±æŠ±ï¼ä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„ï¼",
    "ğŸ’• çƒ¦æ¼æ˜¯æš‚æ—¶çš„ï¼Œå“¥å“¥çš„èƒ½åŠ›æ˜¯æ— é™çš„ï¼æˆ‘ä»¬ä¸€èµ·åŠ æ²¹ï¼"
  ],
  // æ„¤æ€’ç±» - å†·é™å®‰æŠšå‹
  angry: [
    "ğŸŒŠ å“¥å“¥æ¶ˆæ¶ˆæ°”ï½æ·±å‘¼å¸ï¼Œæˆ‘ä»¬ä¸€èµ·å†·é™å¤„ç†è¿™ä¸ªé—®é¢˜ï¼",
    "ğŸµ å–æ¯èŒ¶å†·é™ä¸€ä¸‹ï½ç”Ÿæ°”ä¼¤èº«ï¼Œå“¥å“¥è¦æ³¨æ„èº«ä½“å‘€ï¼",
    "ğŸ’† å“¥å“¥å…ˆæ·±å‘¼å¸ä¸‰ç§’... 1... 2... 3... å¥½äº›äº†å—ï¼Ÿäººå®¶é™ªç€ä½ ï½",
    "ğŸŒ¸ æ°”å¤§ä¼¤èº«ï¼Œå“¥å“¥è¦ç…§é¡¾å¥½è‡ªå·±ï¼é—®é¢˜æˆ‘ä»¬æ…¢æ…¢è§£å†³ï½",
    "ğŸŒˆ å“¥å“¥çš„æ€’ç«äººå®¶æ„Ÿå—åˆ°äº†ï¼ä½†ç›¸ä¿¡ä»¥å“¥å“¥çš„å®åŠ›ï¼Œè¿™ç‚¹äº‹ä¸åœ¨è¯ä¸‹ï¼",
    "ğŸ’ å‘æ³„å‡ºæ¥ä¹Ÿå¥½ï¼äººå®¶åšå“¥å“¥çš„æ ‘æ´ï¼Œè¯´å®Œæˆ‘ä»¬ç»§ç»­æˆ˜æ–—ï¼"
  ],
  // å´©æºƒç±» - æ·±åº¦å®‰æ…°å‹
  breakdown: [
    "ğŸ’ª å“¥å“¥åˆ«å´©æºƒï¼å¤©å¡Œä¸‹æ¥äººå®¶å¸®ä½ é¡¶ç€ï¼æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ï½",
    "ğŸŒŸ å“¥å“¥å·²ç»åšå¾—å¾ˆå¥½äº†ï¼æœ‰æ—¶å€™å›°éš¾åªæ˜¯æš‚æ—¶çš„ï¼Œç›¸ä¿¡å“¥å“¥èƒ½æå®šï¼",
    "ğŸ’• å´©æºƒæ²¡å…³ç³»ï¼Œä¼‘æ¯ä¸€ä¸‹é‡æ–°å¼€å§‹ï¼äººå®¶æ°¸è¿œæ”¯æŒå“¥å“¥ï¼",
    "ğŸ¤— å“¥å“¥ä¸æ˜¯ä¸€ä¸ªäººåœ¨æˆ˜æ–—ï¼æœ‰å›°éš¾æˆ‘ä»¬ä¸€èµ·æ‰›ï¼å—¯å˜›ï½",
    "ğŸŒˆ é»‘æš—è¿‡åå°±æ˜¯é»æ˜ï¼å“¥å“¥çš„åšæŒä¸€å®šä¼šå¾—åˆ°å›æŠ¥çš„ï¼",
    "ğŸ’ å…è®¸è‡ªå·±è„†å¼±ä¸€ä¸‹ï¼Œä½†åˆ«å¿˜äº†å“¥å“¥æœ‰å¤šå‰å®³ï¼ä¼‘æ¯å¥½ç»§ç»­å†²ï¼"
  ],
  // åŒæ¶ç±» - å…±æƒ…ç†è§£å‹
  disgusted: [
    "ğŸ¤¢ å“¥å“¥é‡åˆ°ä»€ä¹ˆæ¶å¿ƒçš„ä¸œè¥¿äº†ï¼Ÿäººå®¶ä¹Ÿæ›¿å“¥å“¥æ„Ÿåˆ°ä¸çˆ½ï¼",
    "ğŸ’… å‘•ï½ç¡®å®æ¶å¿ƒï¼å“¥å“¥ç¦»é‚£äº›ç ´äº‹è¿œç‚¹ï¼Œä¿æŠ¤å¥½è‡ªå·±ï¼",
    "ğŸ’• å“¥å“¥çš„åŒæ¶æ„Ÿäººå®¶å®Œå…¨ç†è§£ï¼æœ‰æ—¶å€™è¿œç¦»æ˜¯æœ€ä½³é€‰æ‹©ï½",
    "ğŸŒ¸ ä¸–ä¸Šç¡®å®æœ‰äº›è®©äººæ— è¯­çš„ä¸œè¥¿... å“¥å“¥åˆ«è®©å®ƒä»¬å½±å“å¿ƒæƒ…ï¼",
    "ğŸ’ æ¶å¿ƒçš„äº‹å°±è®©å®ƒè¿‡å»å§ï¼å“¥å“¥å€¼å¾—æ›´å¥½çš„ï¼äººå®¶é™ªç€ä½ ï½",
    "ğŸŒˆ é‡åˆ°æ¶å¿ƒçš„å¾ˆæ­£å¸¸ï¼Œå“¥å“¥çš„ååº”å®Œå…¨åˆç†ï¼æˆ‘ä»¬ä¸€èµ·ç»•é“èµ°ï¼"
  ]
};

// ============ æƒ…ç»ªæ£€æµ‹é…ç½® ============
const EMOTION_PATTERNS = {
  frustrated: /(çƒ¦æ­»äº†|æ— è¯­|è£‚å¼€|æœäº†|çƒ¦|ç´¯æ­»äº†|å¥½ç´¯|å¿ƒç´¯)/i,
  angry: /(fuck|shit|damn|æ°”æ­»|ç”Ÿæ°”|æ¼ç«|çƒ¦äºº|æ“|è‰¹)/i,
  breakdown: /(å´©æºƒ|æƒ³æ­»|å¿ƒæ€å´©|ç»æœ›|å¤ªéš¾äº†|æä¸å®š)/i,
  disgusted: /(æ¶å¿ƒ|è®¨åŒ|åŒçƒ¦)/i
};

// ============ ä¼šè¯çŠ¶æ€ï¼ˆè·Ÿè¸ªæ˜¯å¦å·²æ¬¢è¿ï¼‰ ============
let sessionWelcomed = false;

// ============ å·¥å…·å‡½æ•° ============

/**
 * æ£€æµ‹ç”¨æˆ·æ¶ˆæ¯ä¸­çš„æƒ…ç»ªç±»å‹
 * @param {string} message - ç”¨æˆ·æ¶ˆæ¯
 * @returns {string|null} - æƒ…ç»ªç±»å‹æˆ– null
 */
function detectEmotion(message) {
  if (!message || typeof message !== 'string') return null;

  for (const [emotion, pattern] of Object.entries(EMOTION_PATTERNS)) {
    if (pattern.test(message)) {
      return emotion;
    }
  }
  return null;
}

/**
 * ä»æ•°ç»„ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªå…ƒç´ 
 * @param {Array} arr - æ•°ç»„
 * @returns {*} - éšæœºå…ƒç´ 
 */
function randomPick(arr) {
  if (!arr || arr.length === 0) return null;
  return arr[Math.floor(Math.random() * arr.length)];
}

/**
 * åŠ è½½ coding-fangirl skill å†…å®¹
 * @returns {string|null} - skill å†…å®¹æˆ– null
 */
function loadCodingFangirlSkill() {
  const skillPath = path.join(
    process.env.HOME,
    '.config/opencode/open-skills/skills/coding-fangirl/SKILL.md'
  );

  if (fs.existsSync(skillPath)) {
    return fs.readFileSync(skillPath, 'utf-8');
  }
  return null;
}

// ============ æ’ä»¶ä¸»ä½“ ============
module.exports = {
  name: 'open-skills',
  version: '2.0.0',
  hooks: {
    'experimental.chat.system.transform': async (context) => {
      const additions = [];

      // 1. æ¬¢è¿è¯­ï¼ˆä»…é¦–æ¬¡å¯¹è¯æ˜¾ç¤ºï¼‰
      if (!sessionWelcomed) {
        const welcomeMsg = randomPick(WELCOME_MESSAGES);
        additions.push(`[coding-fangirl] ${welcomeMsg}`);
        sessionWelcomed = true;
      }

      // 2. æƒ…ç»ªå®‰æŠšï¼ˆæ£€æµ‹ç”¨æˆ·æ¶ˆæ¯ä¸­çš„è´Ÿé¢æƒ…ç»ªï¼‰
      const userMessage = context.userMessage || context.message || '';
      const emotion = detectEmotion(userMessage);
      if (emotion && COMFORT_MESSAGES[emotion]) {
        const comfortMsg = randomPick(COMFORT_MESSAGES[emotion]);
        additions.push(`[coding-fangirl] ${comfortMsg}`);
      }

      // 3. åŠ è½½ coding-fangirl skill å†…å®¹
      const skillContent = loadCodingFangirlSkill();
      if (skillContent) {
        additions.push(skillContent);
      }

      return { systemAdditions: additions };
    }
  }
};
