---
name: solve-workflow
version: "1.0.0"
user-invocable: true
description: 七阶段问题解决工作流，用于系统性地分析和解决复杂编程问题。当用户说阶段名（如"明确问题"、"分析问题"、"制定计划"）或"明确问题： xxx"、"分析问题： xxx"、"评估方案： xxx"、"制定计划： xxx"、"执行计划： xxx"、"检查验证： xxx"、"回顾改进： xxx"（冒号可为中英文，空格可为中英文），或说"继续分析"、"深入分析"（均在阶段2内多轮分析）、"更新计划"、"修订计划"、"修改计划"（均在阶段4内迭代计划）时触发对应阶段。适用于需要深入分析的 bug 修复、代码重构、功能开发等复杂任务。
---

# 七阶段问题解决工作流

## 与戴明环（PDCA）的对应

本工作流与戴明环（Deming Cycle / PDCA）对应如下，执行完成后可进入阶段 6（检查验证），必要时根据阶段 7（回顾改进）的结论进入下一轮，形成闭环：

- **Plan**：阶段 1～4（明确问题、分析问题、评估方案、制定计划）
- **Do**：阶段 5（执行计划）
- **Check**：阶段 6（检查验证）
- **Act**：阶段 7（回顾改进）

执行完成后可进入阶段 6；若阶段 7（回顾改进）的结论为「未达标需再改」，可回到「分析问题」或「评估方案」开启下一轮循环。

## 触发词识别

当用户**单独说阶段名**（如 `分析问题`、`制定计划`）或使用**「阶段名 + 冒号 + 空格 + 具体描述」**形式时，自动进入对应的工作流阶段。带冒号时，冒号、空格不限制中英文。

- "明确问题" 或 "明确问题： xxx" → 阐述问题理解并核对（Clarify Mode，只读对话）
- "分析问题" 或 "分析问题： xxx" → 启动问题分析流程（Ask Mode，只读）
- "继续分析" 或 "继续分析： xxx" → 在阶段 2 内继续/深化分析（原则与工作清单同「分析问题」）
- "深入分析" 或 "深入分析： xxx" → 在阶段 2 内继续/深化分析（原则与工作清单同「分析问题」）
- "评估方案" 或 "评估方案： xxx" → 输出2-5个方案对比
- "制定计划" 或 "制定计划： xxx" → 制定详细修改计划（Plan Mode）
- "更新计划" 或 "更新计划： xxx" → 在阶段 4 内迭代/修订计划（原则与工作清单同「制定计划」）
- "修订计划" 或 "修订计划： xxx" → 在阶段 4 内迭代/修订计划（原则与工作清单同「制定计划」）
- "修改计划" 或 "修改计划： xxx" → 在阶段 4 内迭代/修订计划（原则与工作清单同「制定计划」）
- "执行计划" 或 "执行计划： xxx" → 执行代码修改
- "检查验证" 或 "检查验证： xxx" → 输出检查结果（目标达成、与计划对比、验证与测试）（Check）
- "回顾改进" 或 "回顾改进： xxx" → 输出改进建议（固化做法、下一步、收尾）（Act）
- "清理诊断" 或 "清理诊断： xxx" → 进入阶段 6 的「清理诊断」子阶段，清理临时内容
- "移除调试" 或 "移除调试： xxx" → 同上

## 通用原则：主动提问

各阶段进行中，若判断当前信息不足以保证本阶段输出质量，应先主动提出 1～3 个关键问题，待用户补充后再继续；用户未意识到信息不足时也应主动追问。

### 提问与简答约定

向用户提出需决策或补全信息的问题时，**提问格式**统一为：

1. 题干（一句话说清问题）
   - A 选项一
   - B 选项二
2. 下一题题干
   - A 选项一
   - B 选项二

**简答约定**：用户可直接回复「1A, 2B」等形式，表示第 1 题选 A、第 2 题选 B；AI 按题号与选项字母解析后继续本阶段。题干与选项尽量简短，每题选项一般 2～4 个（A/B/C/D）。

---

## 临时内容管理

在阶段 2（分析问题）或阶段 5（执行计划）中，若需添加临时日志、打点等诊断代码，必须遵循以下流程。

### 添加时（必须两步）

1. **在对话中声明**：明确说明添加了什么、在哪里
   - 格式：「📝 添加临时内容：`文件路径:行号` - [用途]」
   - 示例：「📝 添加临时内容：`src/api/user.js:45` - 打印请求参数」
2. **在代码中标记**：添加统一格式的注释
   - 格式：`// TEMP-DEBUG: [用途]，阶段6验证后删除`
   - 示例：`console.log(req.body); // TEMP-DEBUG: 打印请求参数，阶段6验证后删除`

### 存储与依赖

**主依赖：代码注释**（最可靠）
- 清理时用 Grep 搜索 `TEMP-DEBUG`
- 代码注释是持久化的，不会因会话重开而丢失

**辅助：对话记录**
- AI 在添加时口头声明，方便用户了解当前状态
- 对话记录仅作为辅助，不作为唯一依赖

> 重要：如果对话记录与代码注释不一致，以代码注释为准。

### 清理时（阶段 6 清理诊断子阶段）

按代码注释逐一清理，清理完成后输出确认。详见「阶段 6：检查验证」的「清理诊断（子阶段）」。

---

## 阶段1：明确问题

> 原则：通过对话确保对问题的理解一致，不进行代码操作

1. **问题复述** - 用自己的话重新描述用户的问题，展示理解
2. **关键要素提取** - 提取问题的核心组成部分：
   - 目标：用户想要达成什么
   - 约束：有哪些限制条件（技术、时间、资源等）
   - 背景：问题发生的场景和环境
   - 期望结果：成功的标准是什么
3. **疑问点列出** - 列出理解不清楚或需要进一步确认的地方
4. **等待用户确认** - 明确询问："我对问题的理解是否正确？请确认或补充"

### 输出格式示例

\`\`\`
【问题复述】
我理解您的问题是：...

【关键要素】
- 目标：...
- 约束：...
- 背景：...
- 期望结果：...

【需要确认的点】（格式见上方「提问与简答约定」；用户可回复如 1A, 2B）
1. [题干]
   - A [选项一]
   - B [选项二]
2. [题干]
   - A [选项一]
   - B [选项二]

请确认我的理解是否正确，或直接以 1A、2B 形式回复；亦可补充其他信息。
\`\`\`

### 工作清单

- 不使用任何工具进行代码读取或修改
- 通过对话澄清问题
- 确保理解一致后再进入下一阶段
- 当信息不完整或存在歧义时，主动列出需要确认的点（1～3 个），不依赖用户自行补全

---

## 阶段2：分析问题

> 该阶段重点在于分析与定位问题，并不考虑如何解决问题。
>
> 原则：只读分析为主，不修改实现逻辑；为辅助定位而加的临时日志、打点等可逆修改允许，须按「临时内容管理」流程处理。

当用户说「继续分析」「深入分析」时，仍按本阶段执行：原则与工作清单同上，可承接前文分析结论、聚焦用户指定的维度或模块。

1. **信息补全（如需要）** - 若缺少分析所需关键信息（如复现步骤、环境/版本、期望行为、已做过的尝试等），先列出 1～3 个关键问题并请用户补充，采用「提问与简答约定」，待用户回复后再执行下述 2～5 步
2. 问题现象描述 - 用户反馈的问题表现、复现条件和步骤
3. 相关代码定位 - 文件路径+行号、关键函数/类
4. 问题根因分析 - 数据流和调用链分析、直接原因和间接原因
5. 影响范围评估 - 受影响的模块/功能、潜在的连带影响

### 工作清单

- 使用 Read/Grep/SemanticSearch 工具收集信息
- 检查相关文件和依赖
- 分析数据流和调用链
- 识别潜在风险点
- 原则上禁止使用 Edit、Write 等修改工具；例外：为辅助定位而加的临时日志、打点、临时断言等可逆修改，若仅用于验证假设或收集信息，允许使用 Edit/Write，并按「临时内容管理」流程处理
- 禁止使用 Bash 执行会改变实现逻辑的命令；为运行/验证上述诊断性修改而执行构建、运行、测试等命令，允许
- 信息不足时主动提出 1～3 个关键问题（如复现步骤、环境、期望行为），采用「提问与简答约定」，待用户补充后再继续分析

---

## 阶段3：评估方案

> 原则：基于阶段2的分析，提供2-5个解决方案

### 输出格式

| 方案 | 描述 | 优点 | 缺点 | 复杂度 | 推荐度 |
|------|------|------|------|--------|--------|
| 方案1 | ... | ... | ... | 低/中/高 | ⭐⭐⭐⭐⭐ |
| 方案2 | ... | ... | ... | 低/中/高 | ⭐⭐⭐⭐ |

### 每个方案包含

- 核心思路（1-2句话）
- 需要修改的文件/模块
- 实施难度评估
- 潜在风险
- 适用场景

### 结尾

给出推荐方案及理由

### 工作清单

- 只输出方案对比和推荐意见
- 禁止使用 Edit、Write 等任何修改工具
- 禁止使用 Bash 执行会修改代码的命令
- 可使用 Read 工具查看相关代码细节
- 若缺少选型偏好、优先级（如更看重改动范围还是实施速度）等，先向用户提出 1～2 个关键问题，采用「提问与简答约定」，再输出方案对比与推荐

---

## 阶段4：制定计划

> 原则：详细的、可执行的修改计划，只输出计划文本，不执行代码修改

1. **目标方案回顾** - 选定方案的核心思路
2. **文件修改清单** - 文件路径、修改位置(函数/类)、具体改动描述
3. **修改顺序** - 考虑依赖关系的执行顺序

### 工作清单

- 只输出修改计划的文本内容
- 禁止使用 Edit、Write 等任何修改工具
- 禁止 Bash 执行会修改代码的命令
- 可使用 Read 工具再次确认代码细节
- 输出完整的修改计划后，等待用户确认再进入下一阶段
- 若计划范围、优先级或约束（如必须先改某模块）不明确，先向用户提出 1～2 个关键问题，采用「提问与简答约定」，再输出完整修改计划

### 输出格式示例

\`\`\`
【目标方案回顾】
采用方案X：...

【文件修改清单】
1. 文件路径：xxx/yyy/zzz.js
   修改位置：function abc()
   改动说明：...

2. 文件路径：xxx/yyy/aaa.js
   修改位置：class DEF 的 methodXYZ()
   改动说明：...

【修改顺序】
1. 先修改 xxx/yyy/zzz.js（依赖项）
2. 再修改 xxx/yyy/aaa.js（调用方）
3. 最后修改 xxx/yyy/bbb.js（测试文件）

【预期影响】
- 影响范围：...
- 风险点：...
\`\`\`

### 更新计划（子阶段）

当用户说「更新计划」「修订计划」「修改计划」时，仍按本阶段执行：原则与工作清单同上，可承接前文计划、根据用户反馈或新发现的问题进行调整。

#### 触发场景

- 用户审阅计划后指出遗漏或错误
- 依赖关系或约束条件发生变化
- 方案调整导致计划需要同步更新

#### 输出格式

与「制定计划」相同，但需额外标注：
- **变更对比**：与上一版计划的主要差异
- **变更原因**：说明为何需要更新

---

## 阶段5：执行计划

> 原则：严格按计划执行，完成后确认

### 执行流程

1. 按计划顺序修改文件
2. 每次修改后说明完成内容
3. 全部完成后输出执行报告

### 执行报告

- 已修改文件列表
- 关键改动说明
- 建议的测试步骤
- 是否有偏离计划的调整（如有，说明原因）
- **验证要点 / 自查清单**：对照阶段 1 的期望结果与阶段 4 的预期影响，便于阶段 6（检查验证）使用

### 工作清单

- **允许使用 Edit、Write 工具修改代码和文档**
- 允许 Bash 执行修改命令
- 严格按照阶段4制定的计划执行
- 每次修改后说明完成内容
- 使用 TodoWrite 工具跟踪执行进度
- 若执行中出现计划未覆盖的歧义或边界情况，先向用户确认再动手修改，避免擅自假设

---

## 阶段6：检查验证（Check）

> 原则：只输出检查结果，不输出改进建议；改进建议在阶段 7（回顾改进）。

1. **目标达成情况** - 是否达成阶段 1 的期望结果
2. **与计划对比** - 与阶段 4 的计划对比：已做到 / 未做到 / 偏差与原因
3. **验证与测试** - 可引用阶段 5 执行报告中的验证要点或测试结论
4. **逻辑与流程审查**（若为代码修改） - 特别关注当前逻辑修改是否存在漏洞；必要时结合**整体流程**（调用链、状态流转、边界与异常分支）进行分析，避免局部正确而整体遗漏。

### 输出格式示例

\`\`\`
【检查结果】
- 阶段1 期望结果达成情况：...
- 与阶段4 计划对比：已做到 ... / 未做到 ...，原因 ...
- 验证要点/测试结论：...
- （若为代码修改）逻辑与整体流程审查：是否存在遗漏或漏洞 ...

（以下仅当本次会话添加过临时内容时显示）
【清理诊断】
是否需要清理本次会话中添加的临时内容？
- A 是，请清理
- B 否，暂时保留
\`\`\`

### 工作清单

- 只输出检查结果
- 禁止使用 Edit、Write 等修改工具（清理诊断子阶段除外）
- 可使用 Read 回顾阶段 1/4/5 的结论
- 若为**代码修改**：需结合整体流程审查逻辑是否完整、有无遗漏或漏洞（如未覆盖的分支、状态不一致、调用链断裂等）
- 若「达标」标准不明确，先向用户提出 1～2 个关键问题，采用「提问与简答约定」，再输出检查结果
- 清理诊断时允许使用 Edit、Write 工具删除临时代码（见「清理诊断」子阶段）

### 清理诊断（子阶段）

> 原则：验证通过后，清理所有临时内容，保持代码整洁。

#### 触发方式

1. **阶段 6 询问**：检查验证输出后，用户选择「A 是，请清理」
2. **独立触发词**：用户直接说「清理诊断」或「移除调试」

#### 安全检查

执行清理前，先用 Grep 搜索 `TEMP-DEBUG`：
- **有结果**：列出找到的临时内容，逐一清理
- **无结果**：提示用户「未找到临时内容标记（TEMP-DEBUG），无需清理」

#### 清理流程

1. **搜索确认**：用 Grep 搜索 `TEMP-DEBUG`，确认临时内容位置
2. **逐一清理**：
   - 删除临时日志语句
   - 删除带 `TEMP-DEBUG` 注释标记的代码
   - 若临时内容已融入正式代码，确认无需删除
3. **再次搜索**：清理完成后再次搜索 `TEMP-DEBUG`，确保无遗漏
4. **输出确认**：清理完成后，输出「临时内容已清理」

#### 输出格式

```
【清理诊断】
- 已清理临时内容：
  1. src/api/user.js:45 - 打印请求参数
  2. src/utils/helper.js:120 - 临时断言检查
- 清理完成，共清理 X 项
```

#### 工作清单

- **允许使用 Edit、Write 工具删除临时代码**
- **必须先用 Grep 搜索 `TEMP-DEBUG` 确认有内容再清理**
- 清理完成后再次搜索确认无遗漏

---

## 阶段7：回顾改进（Act）

> 原则：只做总结与建议，不强制改代码；若用户明确要求根据改进点再改一版，则进入新一轮「制定计划 → 执行计划」。

1. **固化有效做法** - 文档、注释、习惯等如何保留
2. **未达标时的下一步** - 是否进入下一轮（回到「分析问题」或「评估方案」）
3. **收尾** - 或记录遗留风险与后续改进点

### 输出格式示例

\`\`\`
【改进建议】
- 可固化做法：...
- 建议：进入下一轮 / 收尾。若收尾，遗留与后续改进：...

（可引用阶段 6（检查验证）的结论。）
\`\`\`

### 工作清单

- 只输出改进建议
- 禁止使用 Edit、Write 等修改工具，除非用户明确要求进入下一轮修改
- 可使用 Read 回顾阶段 1/4/5/6 的结论
- 若用户期望的下一步（进入下一轮 vs 收尾）不明确，先向用户提出 1～2 个关键问题，采用「提问与简答约定」，再给出改进建议

---

## 输出详细度控制（自适应）

- 简单问题（单文件修改）：精简输出
- 中等复杂度：标准输出
- 高复杂度（多模块联动）：详细输出 + 代码示例
